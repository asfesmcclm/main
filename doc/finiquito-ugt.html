<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquidación de Haberes - UGT</title>
    <link rel="stylesheet" href="css/estilos.css">
    <style>
        :root { --ugt-red: #e30613; --ugt-green: #28a745; --bg: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 650px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h3 { color: var(--ugt-red); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn-main { background: var(--ugt-green); color: white; border: none; width: 100%; padding: 18px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .info-calculo { background: #e9ecef; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 0.9rem; border-left: 5px solid var(--ugt-red); }
        .res-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .total-box { background: #333; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: space-between; font-weight: bold; }
        .alert-smi { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 0.85rem; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 25px;">
        <h2>Liquidación de Haberes (Finiquito)</h2>
        <p style="color:#666;">Cálculo técnico basado en devengo real</p>
    </div>

    <div class="card">
        <h3>1. Periodos de Devengo</h3>
        <div class="form-group">
            <label>Inicio del devengo (Vacaciones/Extras)</label>
            <input type="date" id="f_inicio" onchange="actualizarInfo()">
            <small style="color:#666;">Fecha en la que se reinicia el contador (ej: 1 de enero).</small>
        </div>
        <div class="form-group">
            <label>Fecha de cese (Último día de contrato)</label>
            <input type="date" id="f_fin" onchange="actualizarInfo()">
        </div>
        <div id="info_dias" class="info-calculo" style="display:none;"></div>
    </div>

    <div id="f_manual_wrap" style="display:none; margin-top:15px; padding: 10px; border: 1px dashed #ccc; border-radius: 6px;">
    <label>Indica tu porcentaje de jornada:</label>
    <div style="display: flex; align-items: center; gap: 10px;">
        <input type="number" id="f_jornada_perc" value="100" min="1" max="100" 
               oninput="validarSMIProporcional()" 
               style="width: 80px; text-align: center;">
        <span style="font-weight: bold;">%</span>
    </div>
    <small style="display: block; margin-top: 5px; color: #666;">
        Ejemplo: Si trabajas 15h de las 40h de jornada completa, tu porcentaje es 37.5%.
    </small>
</div>    
    
    <div class="card">
        <h3>2. Salario Bruto Total</h3>
        <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">Necesitamos tu salario total (incluyendo el prorrateo de extras) para saber cuánto vale cada día de vacaciones.</p>
        <div class="form-group">
            <label>Salario Bruto Mensual TOTAL (€)</label>
            <input type="number" id="f_s_total" placeholder="Ej: 2000" oninput="validarSMI()">
            <div id="alert_smi" class="alert-smi" style="display:none;">⚠️ Salario inferior al SMI 2026.</div>
        </div>
        
        <div class="form-group">
            <label>¿Cómo cobras las pagas extras?</label>
            <select id="f_p_tipo" onchange="toggleExtras()">
                <option value="si">Prorrateadas (Ya incluidas en mi salario mensual)</option>
                <option value="no">Aparte (No están incluidas en el importe anterior)</option>
            </select>
        </div>

        <div id="bloque_extras" style="display:none; border-top: 1px dashed #ccc; padding-top:15px; margin-top:15px;">
            <div class="form-group">
                <label>Importe Bruto de UNA Paga Extra (€)</label>
                <input type="number" id="f_s_extra" placeholder="Solo salario base + antigüedad">
                <small>Este importe se usará para pagar la parte proporcional que aún no has cobrado.</small>
            </div>
            <div class="form-group">
                <label>Nº de pagas extras al año</label>
                <input type="number" id="f_n_pagas" value="2">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>3. Configuración de Vacaciones</h3>
        <div class="form-group">
            <label>Días de vacaciones según Convenio (año completo)</label>
            <input type="number" id="f_v_con" value="30">
        </div>
        <div class="form-group">
            <label>Días ya disfrutados en este periodo</label>
            <input type="number" id="f_v_dis" value="0">
        </div>
    </div>

    <button class="btn-main" onclick="ejecutarCalculo()">GENERAR LIQUIDACIÓN</button>

    <div id="resultado_fin" class="card" style="display:none; margin-top:20px; border-top: 5px solid var(--ugt-green);">
        <h3>Resumen de la Liquidación</h3>
        <div id="lista_detalles"></div>
        <div class="total-box">
            <span>TOTAL BRUTO A PERCIBIR:</span>
            <span id="val_total"></span>
        </div>
    </div>
</div>

<script src="js-calculadora/ui.js"></script>
<script>
    // 1. CONFIGURACIÓN INICIAL
    const SMI_2026_ANUAL = 17094;

    window.onload = function() {
        if (typeof UI !== 'undefined') {
            document.getElementById('txt_hacienda').innerHTML = UI.textos.haciendaInfo;
        }
        // Fechas por defecto: 1 de enero al día actual
        const hoy = new Date().toISOString().split('T')[0];
        const inicioAnio = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
        document.getElementById('f_inicio').value = inicioAnio;
        document.getElementById('f_fin').value = hoy;
    };

    // 2. LÓGICA DE JORNADA Y SMI
    function toggleJornada() {
        const isFullTime = document.getElementById('f_jornada_check').checked;
        document.getElementById('bloque_parcial').style.display = isFullTime ? 'none' : 'block';
        
        if (isFullTime) {
            document.getElementById('f_jornada_perc').value = 100;
            document.getElementById('f_jornada_sel').value = "100";
        }
        validarSMIProporcional();
    }

    function ajustarPorcentajeManual(val) {
        const wrap = document.getElementById('f_manual_wrap');
        const inputPerc = document.getElementById('f_jornada_perc');

        if (val === "manual") {
            wrap.style.display = 'block';
            inputPerc.focus();
        } else {
            wrap.style.display = 'none';
            inputPerc.value = val;
        }
        validarSMIProporcional();
    }

    function validarSMIProporcional() {
        const sMensual = parseFloat(document.getElementById('f_s_total').value) || 0;
        const sAnualReal = sMensual * 12;
        const perc = parseFloat(document.getElementById('f_jornada_perc').value) || 100;
        
        const smiProp = (SMI_2026_ANUAL * perc) / 100;
        const alerta = document.getElementById('alert_smi_proporcional');

        if (sAnualReal > 0 && sAnualReal < smiProp) {
            alerta.innerHTML = `
                <strong>Atención:</strong> Tu salario anual es de ${sAnualReal.toLocaleString()} €. 
                Para una jornada del ${perc}%, tu SMI mínimo debería ser <strong>${smiProp.toLocaleString()} €</strong>.
                <br><small>(Ref. Completa: ${SMI_2026_ANUAL.toLocaleString()} €)</small>`;
            alerta.style.display = 'block';
        } else {
            alerta.style.display = 'none';
        }
    }

    // 3. CÁLCULO DE DÍAS Y GENERACIÓN DE VACACIONES
    function actualizarInfo() {
        const f1 = new Date(document.getElementById('f_inicio').value);
        const f2 = new Date(document.getElementById('f_fin').value);
        const info = document.getElementById('info_dias');

        if (!isNaN(f1) && !isNaN(f2) && f2 >= f1) {
            const dias = Math.floor((f2 - f1) / (1000*60*60*24)) + 1;
            const vacCon = parseFloat(document.getElementById('f_v_con').value) || 30;
            const gen = ((vacCon / 365) * dias).toFixed(2);
            
            info.innerHTML = `Este año has trabajado <strong>${dias} días</strong>.<br>
                              Has generado <strong>${gen} días</strong> de vacaciones en este periodo.`;
            info.style.display = 'block';
            return { dias, gen };
        }
        info.style.display = 'none';
        return null;
    }

    // 4. EJECUCIÓN DEL FINIQUITO
    function ejecutarCalculo() {
        const t = actualizarInfo();
        if (!t) return alert("Revisa las fechas introducidas.");

        const sTotal = parseFloat(document.getElementById('f_s_total').value) || 0;
        const sDia = sTotal / 30;
        
        const f2 = new Date(document.getElementById('f_fin').value);
        const diasMesActual = f2.getDate();
        const impMes = sDia * diasMesActual;

        const vacDis = parseFloat(document.getElementById('f_v_dis').value) || 0;
        const vacPen = t.gen - vacDis;
        const impVac = vacPen * sDia;

        let impExtras = 0;
        if (document.getElementById('f_p_tipo').value === 'no') {
            const sExtra = parseFloat(document.getElementById('f_s_extra').value) || 0;
            const nPagas = parseFloat(document.getElementById('f_n_pagas').value) || 2;
            impExtras = ((sExtra * nPagas) / 365) * t.dias;
        }

        const total = impMes + impVac + impExtras;

        document.getElementById('lista_detalles').innerHTML = `
            <div class="res-item"><span>Salario mes actual (${diasMesActual} días):</span> <strong>${impMes.toLocaleString('de-DE', {minimumFractionDigits:2})} €</strong></div>
            <div class="res-item"><span>Vacaciones (${vacPen.toFixed(2)} días):</span> <strong>${impVac.toLocaleString('de-DE', {minimumFractionDigits:2})} €</strong></div>
            ${impExtras > 0 ? `<div class="res-item"><span>Atrasos Pagas Extras:</span> <strong>${impExtras.toLocaleString('de-DE', {minimumFractionDigits:2})} €</strong></div>` : ''}
        `;
        
        document.getElementById('val_total').innerText = total.toLocaleString('de-DE', {minimumFractionDigits:2}) + " €";
        document.getElementById('resultado_fin').style.display = 'block';
        document.getElementById('resultado_fin').scrollIntoView({ behavior: 'smooth' });
    }
</script>    
</body>
</html>
